<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Print Layout Calculator — UI</title>
  <style>
    :root{ --bg:#0f1115; --panel:#171a21; --muted:#8892a6; --text:#e6e9ef; --accent:#5eead4; --danger:#ef4444; --ok:#22c55e; --warn:#f59e0b; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    h1,h2,h3{margin:0 0 .5rem}
    h1{font-size:1.25rem}
    h2{font-size:1.05rem;color:#cbd5e1}
    h3{font-size:.95rem;color:#cbd5e1}

    .wrap{max-width:1280px;margin:0 auto;padding:16px 18px 24px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns: 360px 1fr}
    .panel{background:var(--panel);border:1px solid #222632;border-radius:14px;padding:14px;box-shadow:0 4px 24px rgba(0,0,0,.25)}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .row4{display:grid;grid-template-columns:repeat(4,minmax(120px,1fr));gap:6px}
    .rowAuto{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:6px}

    label{display:flex;align-items:center;justify-content:space-between;gap:6px;padding:4px 6px;background:transparent;border:1px solid #283041;border-radius:8px}
    label span{color:var(--muted);font-size:.9rem}
    label input{all:unset;background:#0b0d12;border:1px solid #1b2030;padding:6px 8px;border-radius:8px;width:100px;color:var(--text);text-align:right}
    select{background:#0b0d12;border:1px solid #1b2030;padding:6px 8px;border-radius:8px;color:var(--text);width:100%}
    .k{font-variant-numeric:tabular-nums}

    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:.5rem 0 0}
    .btn{appearance:none;border:1px solid #263041;background:#0d1117;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:#334155;background:#101522}
    .btn.primary{border-color:#1f8a8a;background:#0e1b1b}
    .btn.ghost{background:transparent}

    .tabbar{display:flex;gap:6px;border-bottom:1px solid #1f2430;margin:-14px -14px 10px;padding:0 10px}
    .tab{padding:10px 12px;border-bottom:2px solid transparent;color:#c0c6d4;cursor:pointer}
    .tab.active{color:var(--text);border-color:var(--accent)}
    .tabpanes>section{display:none}
    .tabpanes>section.active{display:block}

    .summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .card{background:#0e1219;border:1px solid #1c2230;border-radius:12px;padding:12px}
    .card .v{font-variant-numeric:tabular-nums;font-weight:600}

    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px dashed #223}
    .table th{text-align:left;color:#cbd5e1}

    .preview{background:#0b0d12;border:1px solid #1b2030;border-radius:12px;display:flex;align-items:center;justify-content:center;min-height:360px}
    .legend{display:flex;gap:10px;flex-wrap:wrap;font-size:.9rem;margin-top:8px;color:#cbd5e1}
    .dot{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px}
    .dot.grid{background:#26323e}
    .dot.doc{background:#64748b}
    .dot.cut{background:#22d3ee}
    .dot.score{background:#a78bfa}

    @media print{
      body{background:#fff;color:#000}
      .no-print{display:none !important}
      .print-only{display:block !important}
      .panel{border:none;box-shadow:none}
      .wrap{max-width:none}
    }
    .print-only{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid cols-2">
      <!-- LEFT: Inputs -->
      <aside class="panel" id="inputs">
        <h1>Layout Inputs</h1>
        <div class="toolbar no-print">
          <button class="btn" id="preset-letter">Letter 8.5×11</button>
          <button class="btn" id="preset-1218">12×18</button>
          <button class="btn ghost" id="swap-wh">Swap W/H</button>
          <span>Units:</span>
          <select id="units"><option value="in">inches</option><option value="mm">millimeters</option></select>
        </div>

        <div class="card" style="margin-top:10px">
          <h2>Sheet</h2>
          <div class="row">
            <label><span>Width</span><input id="sheetW" type="number" step="0.001" value="12"></label>
            <label><span>Height</span><input id="sheetH" type="number" step="0.001" value="18"></label>
          </div>
        </div>

        <div class="card" style="margin-top:8px">
          <h2>Document</h2>
          <div class="row">
            <label><span>Width</span><input id="docW" type="number" step="0.001" value="3.5"></label>
            <label><span>Height</span><input id="docH" type="number" step="0.001" value="2"></label>
          </div>
        </div>

        <div class="card" style="margin-top:8px">
          <h2>Gutter</h2>
          <div class="row">
            <label><span>Horizontal</span><input id="gutH" type="number" step="0.001" value="0.125"></label>
            <label><span>Vertical</span><input id="gutV" type="number" step="0.001" value="0.125"></label>
          </div>
        </div>

        <div class="card" style="margin-top:8px">
          <h2>Docs (limit)</h2>
          <div class="row">
            <label title="Leave blank for auto max"><span>Across</span><input id="forceAcross" type="number" step="1" min="1" placeholder="auto"></label>
            <label title="Leave blank for auto max"><span>Down</span><input id="forceDown" type="number" step="1" min="1" placeholder="auto"></label>
          </div>
        </div>

        <div class="card" style="margin-top:8px">
          <h2>Margins (inside printable)</h2>
          <div class="row4">
            <label><span>Top</span><input id="mTop" type="number" step="0.001" value="" placeholder="auto"></label>
            <label><span>Right</span><input id="mRight" type="number" step="0.001" value="" placeholder="auto"></label>
            <label><span>Bottom</span><input id="mBottom" type="number" step="0.001" value="" placeholder="auto"></label>
            <label><span>Left</span><input id="mLeft" type="number" step="0.001" value="" placeholder="auto"></label>
          </div>
        </div>

        <div class="card" style="margin-top:8px">
          <h2>Non‑Printable Edge</h2>
          <div class="row4">
            <label><span>Top</span><input id="npTop" type="number" step="0.001" value="0.0625"></label>
            <label><span>Right</span><input id="npRight" type="number" step="0.001" value="0.0625"></label>
            <label><span>Bottom</span><input id="npBottom" type="number" step="0.001" value="0.0625"></label>
            <label><span>Left</span><input id="npLeft" type="number" step="0.001" value="0.0625"></label>
          </div>
        </div>

        <div class="toolbar no-print">
          <button class="btn primary" id="calcBtn">Update Preview</button>
          <button class="btn" id="resetBtn">Reset</button>
          <span class="k" id="status"></span>
        </div>
      </aside>

      <!-- RIGHT: Output/Tabs -->
      <main class="panel">
        <nav class="tabbar no-print">
          <div class="tab" data-tab="summary">Summary</div>
          <div class="tab active" data-tab="preview">Grid Preview</div>
          <div class="tab" data-tab="finishing">Cuts / Slits</div>
          <div class="tab" data-tab="scores">Scores</div>
          <div class="tab" data-tab="print">Print</div>
        </nav>

        <div class="tabpanes">
          <section id="tab-summary">
            <div class="summary">
              <div class="card"><h3>Counts</h3>
                <div>Across: <span class="v" id="vAcross">—</span></div>
                <div>Down: <span class="v" id="vDown">—</span></div>
                <div>Total: <span class="v" id="vTotal">—</span></div>
              </div>
              <div class="card"><h3>Layout Area</h3>
                <div>W × H: <span class="v" id="vLayout">—</span></div>
                <div>Origin: <span class="v" id="vOrigin">—</span></div>
                <div>Realized Margins: <span class="v" id="vRealMargins">—</span></div>
              </div>
              <div class="card"><h3>Utilization</h3>
                <div>Used W/H: <span class="v" id="vUsed">—</span></div>
                <div>Trailing W/H: <span class="v" id="vTrail">—</span></div>
              </div>
            </div>
          </section>

          <section id="tab-preview" class="active">
            <div class="preview"><svg id="svg" width="960" height="600" viewBox="0 0 960 600" aria-label="sheet preview"></svg></div>
            <div class="legend no-print">
              <span><i class="dot grid"></i>Layout Area</span>
              <span><i class="dot doc"></i>Documents</span>
              <span><i class="dot cut"></i>Cut/Slit Lines</span>
              <span><i class="dot score"></i>Scores</span>
            </div>
          </section>

          <section id="tab-finishing">
            <h3 style="margin-bottom:6px">Cut & Slit Systems</h3>
            <div class="grid" style="grid-template-columns:1fr 1fr">
              <div class="card"><h3>Cuts (Y edges)</h3>
                <table class="table" id="tblCuts"><thead><tr><th>Label</th><th>in</th><th>mm</th></tr></thead><tbody></tbody></table>
              </div>
              <div class="card"><h3>Slits (X edges)</h3>
                <table class="table" id="tblSlits"><thead><tr><th>Label</th><th>in</th><th>mm</th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </section>

          <section id="tab-scores">
            <div class="card" style="margin-bottom:10px">
              <h3>Score Offsets (relative within document)</h3>
              <div class="row">
                <label title="CSV, 0–1 (e.g., 0.5 or 0.33,0.66)"><span>Vertical offsets</span>
                  <input id="scoresV" type="text" value="" placeholder="e.g., 0.5"></label>
                <label title="CSV, 0–1"><span>Horizontal offsets</span>
                  <input id="scoresH" type="text" value="" placeholder="e.g., 0.5"></label>
              </div>
              <div class="toolbar no-print"><button class="btn" id="applyScores">Apply Scores</button><span class="muted">Leave blank for no scores</span></div>
            </div>
            <div class="grid" style="grid-template-columns:1fr 1fr">
              <div class="card"><h3>Scores (Y)</h3>
                <table class="table" id="tblScoresH"><thead><tr><th>Label</th><th>in</th><th>mm</th></tr></thead><tbody></tbody></table>
              </div>
              <div class="card"><h3>Scores (X)</h3>
                <table class="table" id="tblScoresV"><thead><tr><th>Label</th><th>in</th><th>mm</th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </section>

          <section id="tab-print">
            <div class="row">
              <div class="card">
                <h3>Print Summary</h3>
                <p class="muted">Choose a page size. We inject an <code>@page</code> rule, then open print.</p>
                <div class="toolbar no-print"><button class="btn" id="btnPrintLetter">Print — Letter</button><button class="btn" id="btnPrint1218">Print — 12×18</button></div>
                <ul>
                  <li><b>Sheet</b>: <span id="pSheet">—</span></li>
                  <li><b>Doc</b>: <span id="pDoc">—</span></li>
                  <li><b>Counts</b>: <span id="pCounts">—</span></li>
                  <li><b>Gutter</b>: <span id="pGutter">—</span></li>
                  <li><b>Margins</b>: <span id="pMargins">—</span></li>
                </ul>
              </div>
              <div class="card"><h3>What prints?</h3>
                <p class="muted">Summary cards and finishing tables. Inputs/tabs are hidden.</p>
              </div>
            </div>
            <div class="print-only" id="printTables"></div>
          </section>
        </div>
      </main>
    </div>
  </div>

  <script>
    // ===== Calculation Engine =====
    const MM_PER_INCH = 25.4;
    const clampToZero = v => Math.max(0, v);
    const toNumber = v => { const n = Number(v); return Number.isFinite(n) ? n : 0; };
    const inchesToMillimeters = (inches, p=3) => Number((inches*MM_PER_INCH).toFixed(p));
    const normalizePerSide = (s={}) => ({ top: toNumber(s.top), right: toNumber(s.right), bottom: toNumber(s.bottom), left: toNumber(s.left) });

    function createCalculationContext({ sheet, document, gutter, margins = {}, nonPrintable = {} }){
      const m = normalizePerSide(margins);
      const np = normalizePerSide(nonPrintable);
      const sw = toNumber(sheet?.width), sh = toNumber(sheet?.height);
      const dw = toNumber(document?.width), dh = toNumber(document?.height);
      const gh = toNumber(gutter?.horizontal), gv = toNumber(gutter?.vertical);
      const effW = clampToZero(sw - np.left - np.right);
      const effH = clampToZero(sh - np.top - np.bottom);
      const layW = clampToZero(effW - m.left - m.right);
      const layH = clampToZero(effH - m.top - m.bottom);
      return {
        sheet:{ rawWidth: sw, rawHeight: sh, nonPrintable: np, effectiveWidth: effW, effectiveHeight: effH },
        document:{ width: dw, height: dh },
        gutter:{ horizontal: gh, vertical: gv },
        margins: m,
        layoutArea:{ width: layW, height: layH, originX: np.left + m.left, originY: np.top + m.top }
      };
    }

    function calculateDocumentCount(avail, span, gut){ if(avail<=0||span<=0) return 0; const g = clampToZero(gut); return clampToZero(Math.floor((avail+g)/(span+g))); }
    function calculateAxisUsage(avail, span, gut, count){ if(count<=0) return {usedSpan:0, trailingMargin:avail}; const g=clampToZero(gut); const used = count*span + Math.max(0, count-1)*g; return { usedSpan: used, trailingMargin: clampToZero(avail-used) }; }

    function calculateLayout(ctx){
      const {layoutArea, document, gutter, margins, sheet} = ctx;
      const maxAcross = calculateDocumentCount(layoutArea.width, document.width, gutter.horizontal);
      const maxDown   = calculateDocumentCount(layoutArea.height, document.height, gutter.vertical);
      const h = calculateAxisUsage(layoutArea.width, document.width, gutter.horizontal, maxAcross);
      const v = calculateAxisUsage(layoutArea.height, document.height, gutter.vertical, maxDown);
      return { sheet, margins, document, gutter, layoutArea,
        counts:{ across: maxAcross, down: maxDown }, usage:{ horizontal:h, vertical:v },
        realizedMargins:{ left:margins.left, top:margins.top, right:margins.right + h.trailingMargin, bottom:margins.bottom + v.trailingMargin } };
    }

    function applyCountOverrides(layout, desiredAcross, desiredDown){
      const across = Math.min(layout.counts.across, desiredAcross ?? layout.counts.across);
      const down   = Math.min(layout.counts.down,   desiredDown   ?? layout.counts.down);
      const h = calculateAxisUsage(layout.layoutArea.width, layout.document.width, layout.gutter.horizontal, across);
      const v = calculateAxisUsage(layout.layoutArea.height, layout.document.height, layout.gutter.vertical, down);
      return { ...layout,
        counts:{ across, down },
        usage:{ horizontal:h, vertical:v },
        realizedMargins:{ left: layout.margins.left, top: layout.margins.top,
          right: layout.margins.right + h.trailingMargin, bottom: layout.margins.bottom + v.trailingMargin } };
    }

    function generateEdgePositions(startOffset, docSpan, gutterSpan, docCount){ const out=[]; const g=clampToZero(gutterSpan); for(let i=0;i<docCount;i++){ const lead=startOffset + i*(docSpan+g); const trail=lead+docSpan; out.push(lead, trail);} return out; }
    function generateScorePositions(startOffset, docSpan, gutterSpan, docCount, offsets){
      const raw = Array.isArray(offsets) ? offsets : [];
      const offs = raw.filter(x=> Number.isFinite(Number(x))).map(x=> Math.min(Math.max(Number(x)||0,0),1));
      if(offs.length===0) return [];
      const g=clampToZero(gutterSpan); const out=[];
      for(let i=0;i<docCount;i++){ const s=startOffset + i*(docSpan+g); offs.forEach(o=> out.push(s + docSpan*o)); }
      return out;
    }
    const mapPositionsToReadout = (label, positions) => positions.map((p,i)=>({ label: `${label} ${i+1}`, inches: Number(p.toFixed(3)), millimeters: inchesToMillimeters(p) }));

    function calculateFinishing(layout, scoreOptions={}){
      const { layoutArea, counts, document, gutter } = layout;
      const hEdges = generateEdgePositions(layoutArea.originY, document.height, gutter.vertical, counts.down);
      const vEdges = generateEdgePositions(layoutArea.originX, document.width, gutter.horizontal, counts.across);
      const hScores = generateScorePositions(layoutArea.originY, document.height, gutter.vertical, counts.down, scoreOptions.horizontalOffsets);
      const vScores = generateScorePositions(layoutArea.originX, document.width, gutter.horizontal, counts.across, scoreOptions.verticalOffsets);
      return { cuts: mapPositionsToReadout("Cut", hEdges), slits: mapPositionsToReadout("Slit", vEdges),
               scores: { horizontal: mapPositionsToReadout("Score", hScores), vertical: mapPositionsToReadout("Score", vScores) } };
    }

    // ===== UI Helpers =====
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const readNumber = id => { const v=$(id).value; const n=Number(v); return Number.isFinite(n)?n:0; };
    const readIntOptional = id => { const raw=(($(id).value)||'').trim(); if(raw==='') return null; const n=Math.max(1,Math.floor(Number(raw))); return Number.isFinite(n)?n:null; };
    const isEmpty = id => (($(id).value ?? '').toString().trim() === '');
    const parseOffsets = s => (s||'').split(',').map(x=>x.trim()).filter(Boolean).map(Number).filter(n=>Number.isFinite(n));
    const fmtIn = inches => `${inches.toFixed(3)} in / ${inchesToMillimeters(inches).toFixed(2)} mm`;

    function currentInputs(){
      const units = $('#units').value;
      const u = v => units==='mm' ? (Number(v)||0)/MM_PER_INCH : (Number(v)||0);
      const autoMargins = isEmpty('#mTop') && isEmpty('#mRight') && isEmpty('#mBottom') && isEmpty('#mLeft');
      return { units,
        sheet:{ width:u(readNumber('#sheetW')), height:u(readNumber('#sheetH')) },
        document:{ width:u(readNumber('#docW')), height:u(readNumber('#docH')) },
        gutter:{ horizontal:u(readNumber('#gutH')), vertical:u(readNumber('#gutV')) },
        margins: autoMargins ? {top:0,right:0,bottom:0,left:0} : { top:u(readNumber('#mTop')), right:u(readNumber('#mRight')), bottom:u(readNumber('#mBottom')), left:u(readNumber('#mLeft')) },
        nonPrintable:{ top:u(readNumber('#npTop')), right:u(readNumber('#npRight')), bottom:u(readNumber('#npBottom')), left:u(readNumber('#npLeft')) },
        scoreV: parseOffsets($('#scoresV')?.value||''),
        scoreH: parseOffsets($('#scoresH')?.value||''),
        forceAcross: readIntOptional('#forceAcross'),
        forceDown: readIntOptional('#forceDown'),
        autoMargins };
    }

    function setPreset(w,h){
      const units=$('#units').value; if(units==='mm'){ w=(w*MM_PER_INCH).toFixed(2); h=(h*MM_PER_INCH).toFixed(2);} 
      $('#sheetW').value=w; $('#sheetH').value=h; status(`Preset ${w}×${h} ${units}`);
    }
    function status(txt){ $('#status').textContent = txt; }

    function fillTable(tbody, rows){ tbody.innerHTML = rows.map(r=>`<tr><td>${r.label}</td><td class="k">${r.inches.toFixed(3)}</td><td class="k">${r.millimeters.toFixed(2)}</td></tr>`).join(''); }

    function update(){
      const inp = currentInputs();
      let ctx = createCalculationContext(inp);
      let layout = calculateLayout(ctx);
      layout = applyCountOverrides(layout, inp.forceAcross, inp.forceDown);

      // Auto-center margins if blank
      if(inp.autoMargins){
        const effW = ctx.sheet.effectiveWidth, effH = ctx.sheet.effectiveHeight;
        const usedW = layout.usage.horizontal.usedSpan, usedH = layout.usage.vertical.usedSpan;
        const leftRight = clampToZero((effW - usedW)/2), topBottom = clampToZero((effH - usedH)/2);
        ctx = createCalculationContext({ sheet:{width:ctx.sheet.rawWidth,height:ctx.sheet.rawHeight}, document:ctx.document, gutter:ctx.gutter, margins:{top:topBottom,right:leftRight,bottom:topBottom,left:leftRight}, nonPrintable:ctx.sheet.nonPrintable });
        layout = calculateLayout(ctx);
        layout = applyCountOverrides(layout, inp.forceAcross, inp.forceDown);
        const f = inches => inp.units==='mm' ? (inches*MM_PER_INCH).toFixed(3) : inches.toFixed(3);
        $('#mTop').value=f(topBottom); $('#mRight').value=f(leftRight); $('#mBottom').value=f(topBottom); $('#mLeft').value=f(leftRight);
      }

      const fin = calculateFinishing(layout, { horizontalOffsets: inp.scoreH, verticalOffsets: inp.scoreV });

      // Summary
      $('#vAcross').textContent = layout.counts.across;
      $('#vDown').textContent = layout.counts.down;
      $('#vTotal').textContent = layout.counts.across * layout.counts.down;
      $('#vLayout').textContent = `${layout.layoutArea.width.toFixed(3)} × ${layout.layoutArea.height.toFixed(3)} in`;
      $('#vOrigin').textContent = `x ${layout.layoutArea.originX.toFixed(3)}, y ${layout.layoutArea.originY.toFixed(3)} in`;
      $('#vRealMargins').textContent = `L ${layout.realizedMargins.left.toFixed(3)}, T ${layout.realizedMargins.top.toFixed(3)}, R ${layout.realizedMargins.right.toFixed(3)}, B ${layout.realizedMargins.bottom.toFixed(3)} in`;
      $('#vUsed').textContent = `${layout.usage.horizontal.usedSpan.toFixed(3)} × ${layout.usage.vertical.usedSpan.toFixed(3)} in`;
      $('#vTrail').textContent = `${layout.usage.horizontal.trailingMargin.toFixed(3)} × ${layout.usage.vertical.trailingMargin.toFixed(3)} in`;

      fillTable($('#tblCuts tbody'), fin.cuts);
      fillTable($('#tblSlits tbody'), fin.slits);
      fillTable($('#tblScoresH tbody'), fin.scores.horizontal);
      fillTable($('#tblScoresV tbody'), fin.scores.vertical);

      $('#pSheet').textContent = fmtIn(ctx.sheet.rawWidth) + ' × ' + fmtIn(ctx.sheet.rawHeight);
      $('#pDoc').textContent = fmtIn(ctx.document.width) + ' × ' + fmtIn(ctx.document.height);
      $('#pCounts').textContent = `${layout.counts.across} × ${layout.counts.down} = ${layout.counts.across*layout.counts.down}`;
      $('#pGutter').textContent = `${fmtIn(ctx.gutter.horizontal)} (H), ${fmtIn(ctx.gutter.vertical)} (V)`;
      $('#pMargins').textContent = `T ${fmtIn(ctx.margins.top)}, R ${fmtIn(ctx.margins.right)}, B ${fmtIn(ctx.margins.bottom)}, L ${fmtIn(ctx.margins.left)}`;

      drawSVG(layout, fin);
      status('Updated');
    }

    function drawSVG(layout, fin){
      const svg = $('#svg'); const W = svg.viewBox.baseVal.width, H = svg.viewBox.baseVal.height; const pad=20; svg.innerHTML='';
      const sx=(W-2*pad)/layout.sheet.rawWidth, sy=(H-2*pad)/layout.sheet.rawHeight, s=Math.min(sx,sy);
      const offX = pad + (W-2*pad - layout.sheet.rawWidth*s)/2; const offY = pad + (H-2*pad - layout.sheet.rawHeight*s)/2;
      const R=(x,y,w,h,cls,stroke='#26323e')=>{ const r=document.createElementNS('http://www.w3.org/2000/svg','rect'); r.setAttribute('x',offX+x*s); r.setAttribute('y',offY+y*s); r.setAttribute('width',Math.max(0.5,w*s)); r.setAttribute('height',Math.max(0.5,h*s)); r.setAttribute('fill',cls==='docs'?'#64748b33':'none'); r.setAttribute('stroke',stroke); r.setAttribute('rx',6); svg.appendChild(r); };
      const L=(x1,y1,x2,y2,stroke,width=1.5)=>{ const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',offX+x1*s); l.setAttribute('y1',offY+y1*s); l.setAttribute('x2',offX+x2*s); l.setAttribute('y2',offY+y2*s); l.setAttribute('stroke',stroke); l.setAttribute('stroke-width',width); svg.appendChild(l); };
      R(0,0,layout.sheet.rawWidth,layout.sheet.rawHeight,'sheet','#334155');
      R(layout.layoutArea.originX,layout.layoutArea.originY,layout.layoutArea.width,layout.layoutArea.height,'layout','#26323e');
      const across=layout.counts.across, down=layout.counts.down;
      for(let y=0;y<down;y++){
        for(let x=0;x<across;x++){
          const dx=layout.layoutArea.originX + x*(layout.document.width+layout.gutter.horizontal);
          const dy=layout.layoutArea.originY + y*(layout.document.height+layout.gutter.vertical);
          R(dx,dy,layout.document.width,layout.document.height,'docs','#475569');
        }
      }
      fin.cuts.forEach(c=> L(layout.layoutArea.originX,c.inches, layout.layoutArea.originX+layout.layoutArea.width, c.inches, '#22d3ee',1));
      fin.slits.forEach(s=> L(s.inches, layout.layoutArea.originY, s.inches, layout.layoutArea.originY+layout.layoutArea.height, '#22d3ee',1));
      fin.scores.horizontal.forEach(sc=> L(layout.layoutArea.originX, sc.inches, layout.layoutArea.originX+layout.layoutArea.width, sc.inches, '#a78bfa',1));
      fin.scores.vertical.forEach(sc=> L(sc.inches, layout.layoutArea.originY, sc.inches, layout.layoutArea.originY+layout.layoutArea.height, '#a78bfa',1));
    }

    // Tabs
    $$('.tab').forEach(t=> t.addEventListener('click', ()=>{ $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); const target=t.dataset.tab; $$('.tabpanes>section').forEach(s=>s.classList.remove('active')); $('#tab-'+target).classList.add('active'); }));

    // Actions
    $('#preset-letter').addEventListener('click', ()=> setPreset(8.5,11));
    $('#preset-1218').addEventListener('click', ()=> setPreset(12,18));
    $('#swap-wh').addEventListener('click', ()=>{ const w=$('#docW').value, h=$('#docH').value; $('#docW').value=h; $('#docH').value=w; update(); });
    $('#units').addEventListener('change', ()=>{ status('Units changed'); update(); });
    $('#calcBtn').addEventListener('click', update);
    $('#resetBtn').addEventListener('click', ()=> location.reload());

    function withPageSize(wIn,hIn){ const id='page-size-style'; let tag=document.getElementById(id); if(!tag){ tag=document.createElement('style'); tag.id=id; document.head.appendChild(tag);} tag.textContent=`@page{ size: ${wIn}in ${hIn}in; margin: 12mm; }`; }
    $('#btnPrintLetter').addEventListener('click', ()=>{ withPageSize(8.5,11); window.print(); });
    $('#btnPrint1218').addEventListener('click', ()=>{ withPageSize(12,18); window.print(); });

    $('#applyScores').addEventListener('click', update);

    // ===== Tiny Console Tests (sanity) =====
    (function tests(){
      console.assert(inchesToMillimeters(1)===25.4, '1 inch should be 25.4 mm');
      console.assert(calculateDocumentCount(10,2,0)===5, '10/2=5 docs');
      const ctx = createCalculationContext({ sheet:{width:12,height:18}, document:{width:3.5,height:2}, gutter:{horizontal:0.125,vertical:0.125}, margins:{top:0,right:0,bottom:0,left:0}, nonPrintable:{top:0.0625,right:0.0625,bottom:0.0625,left:0.0625} });
      const layout = calculateLayout(ctx);
      console.assert(layout.counts.across>=1 && layout.counts.down>=1, 'Counts should be >=1 with defaults');
    })();

    // Initial render
    update();
    document.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter') update(); });
  </script>
</body>
</html>
